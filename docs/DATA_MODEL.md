# Data Model Documentation

## Database Schema Overview

The Social Media Sentiment Analytics System uses **PostgreSQL 15** as the production database with Docker containerization for development. The schema supports unified cross-platform social media data for Reddit and YouTube.

## Database Configuration

### Docker Setup
```yaml
services:
  postgres:
    image: postgres:15
    ports:
      - "5433:5432"  # Port 5433 to avoid conflicts
    environment:
      POSTGRES_DB: socialsentiment
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password123
```

### Connection Details
- **Host**: localhost:5433
- **Database**: socialsentiment
- **Username**: postgres
- **Password**: password123
- **Version**: PostgreSQL 15.14

## Core Entities

### 1. SocialPost Entity

**Table**: `social_posts`

**Purpose**: Central entity representing social media posts across Reddit and YouTube platforms.

#### Production Schema (PostgreSQL)
```sql
CREATE TABLE social_posts (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    external_id VARCHAR(100) NOT NULL,
    platform VARCHAR(20) NOT NULL CHECK (platform IN ('REDDIT','YOUTUBE')),
    title VARCHAR(500) NOT NULL,
    content TEXT,
    author VARCHAR(100) NOT NULL,
    created_at TIMESTAMP(6) NOT NULL,
    ingested_at TIMESTAMP(6) NOT NULL,
    processed_at TIMESTAMP(6),
    content_hash VARCHAR(64),
    
    -- Engagement metrics (2025 version - no downvotes)
    upvotes BIGINT DEFAULT 0,           -- Reddit only
    like_count BIGINT DEFAULT 0,        -- YouTube only  
    view_count BIGINT DEFAULT 0,        -- YouTube only
    comment_count BIGINT DEFAULT 0,     -- Both platforms
    share_count BIGINT DEFAULT 0,       -- Both platforms
    engagement_score DOUBLE PRECISION DEFAULT 0.0, -- Calculated field
    
    -- Platform-specific context
    subreddit VARCHAR(100),             -- Reddit: technology, programming
    video_id VARCHAR(500),              -- YouTube: dQw4w9WgXcQ  
    url VARCHAR(1000),                  -- External URL
    
    -- Constraints
    CONSTRAINT uk_external_platform UNIQUE (external_id, platform),
    CONSTRAINT idx_external_platform UNIQUE (external_id, platform)
);
```

#### Production Indexes
```sql
-- Performance indexes (automatically created by Hibernate)
CREATE INDEX idx_platform_created ON social_posts (platform, created_at);
CREATE INDEX idx_engagement ON social_posts (engagement_score);
CREATE INDEX idx_subreddit ON social_posts (subreddit);
CREATE INDEX idx_video_id ON social_posts (video_id);

-- Unique constraint indexes
CREATE UNIQUE INDEX uk_external_platform ON social_posts (external_id, platform);
CREATE UNIQUE INDEX idx_external_platform ON social_posts (external_id, platform);
```

#### Field Mapping by Platform

| Field | Reddit | YouTube | Description |
|-------|--------|---------|-------------|
| `external_id` | Post ID from Reddit | Video ID from YouTube | Unique identifier per platform |
| `title` | Post title | Video title | Both platforms have titles in 2025 |
| `content` | Post selftext | Video description | Required for Reddit, optional for YouTube |
| `author` | Reddit username | Channel name | Content creator identifier |
| `upvotes` | Reddit score | NULL | Reddit engagement metric |
| `like_count` | NULL | YouTube likes | YouTube engagement metric |
| `view_count` | NULL | YouTube views | YouTube-specific metric |
| `subreddit` | r/technology | NULL | Reddit community |
| `video_id` | NULL | YouTube ID | YouTube-specific identifier |

### 2. SentimentData Entity (Production Ready)

**Table**: `sentiment_data`

**Purpose**: Stores sentiment analysis results with confidence metrics.

#### Schema Definition
```sql
CREATE TABLE sentiment_data (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    social_post_id BIGINT NOT NULL,
    sentiment_label VARCHAR(20) NOT NULL CHECK (sentiment_label IN ('POSITIVE','NEGATIVE','NEUTRAL','MIXED','UNKNOWN')),
    sentiment_score DOUBLE PRECISION NOT NULL,
    confidence DOUBLE PRECISION NOT NULL,
    processed_at TIMESTAMP(6) NOT NULL,
    
    -- Foreign key constraint
    CONSTRAINT FKd3bis7rw8bvnx0hios3f767v8 
        FOREIGN KEY (social_post_id) REFERENCES social_posts(id),
    
    -- Unique constraint (one sentiment per post)
    CONSTRAINT UK19aemot07gyi5eo4mrx713wmb UNIQUE (social_post_id)
);

-- Performance indexes
CREATE INDEX idx_sentiment_label ON sentiment_data (sentiment_label);
CREATE INDEX idx_sentiment_score ON sentiment_data (sentiment_score);
```

#### Sentiment Labels (Enum Implementation)
```java
public enum SentimentLabel {
    POSITIVE,   // > 0.6 sentiment score
    NEUTRAL,    // 0.4 to 0.6 sentiment score  
    NEGATIVE,   // < 0.4 sentiment score
    MIXED,      // Complex sentiment patterns
    UNKNOWN     // Analysis failed or uncertain
}
```

### 3. Supporting Tables (Collection Tables)

#### Hashtags, Mentions, and Topics
```sql
-- Post hashtags
CREATE TABLE post_hashtags (
    post_id BIGINT NOT NULL,
    hashtag VARCHAR(255),
    CONSTRAINT FK520o88jk9gho2ppnsswhle593 
        FOREIGN KEY (post_id) REFERENCES social_posts(id)
);

-- Post mentions
CREATE TABLE post_mentions (
    post_id BIGINT NOT NULL,
    mention VARCHAR(255),
    CONSTRAINT FKlpktbddf60u8ftg2j4q33nn7r 
        FOREIGN KEY (post_id) REFERENCES social_posts(id)
);

-- Post topics
CREATE TABLE post_topics (
    post_id BIGINT NOT NULL,
    topic VARCHAR(255),
    CONSTRAINT FK6m87c5w5j3ik8magos2roybbi 
        FOREIGN KEY (post_id) REFERENCES social_posts(id)
);
```

## Platform Enum Implementation

```java
public enum Platform {
    REDDIT("REDDIT", "Reddit"),
    YOUTUBE("YOUTUBE", "YouTube");
    
    private final String code;
    private final String displayName;
    
    Platform(String code, String displayName) {
        this.code = code;
        this.displayName = displayName;
    }
    
    // Getters
    public String getCode() { return code; }
    public String getDisplayName() { return displayName; }
}
```

## Data Access Layer

### SocialPostRepository (PostgreSQL Optimized)

```java
public interface SocialPostRepository extends JpaRepository<SocialPost, Long> {
    
    // Duplicate detection (production implemented)
    boolean existsByExternalIdAndPlatform(String externalId, Platform platform);
    
    // Statistics queries (production implemented)
    long count();
    
    @Query("SELECT COUNT(s) FROM SocialPost s WHERE s.platform = ?1 AND s.createdAt >= ?2")
    Long countByPlatformSince(Platform platform, LocalDateTime since);
    
    // Platform filtering (ready for implementation)
    List<SocialPost> findByPlatform(Platform platform);
    
    Page<SocialPost> findByPlatformIn(List<Platform> platforms, Pageable pageable);
    
    // Content search with PostgreSQL full-text search
    @Query("SELECT s FROM SocialPost s WHERE " +
           "(LOWER(s.title) LIKE LOWER(CONCAT('%', :keyword, '%')) OR " +
           " LOWER(s.content) LIKE LOWER(CONCAT('%', :keyword, '%'))) " +
           "ORDER BY s.engagementScore DESC")
    List<SocialPost> findByContentContaining(@Param("keyword") String keyword, Pageable pageable);
    
    // Reddit-specific queries
    List<SocialPost> findBySubreddit(String subreddit);
    
    @Query("SELECT s.subreddit, COUNT(s), AVG(s.engagementScore) " +
           "FROM SocialPost s WHERE s.platform = 'REDDIT' AND s.subreddit IS NOT NULL " +
           "GROUP BY s.subreddit ORDER BY AVG(s.engagementScore) DESC")
    List<Object[]> getSubredditStats();
    
    // YouTube-specific queries
    List<SocialPost> findByVideoId(String videoId);
    
    @Query("SELECT s.author, COUNT(s), AVG(s.engagementScore) " +
           "FROM SocialPost s WHERE s.platform = 'YOUTUBE' " +
           "GROUP BY s.author ORDER BY AVG(s.engagementScore) DESC")
    List<Object[]> getChannelStats();
}
```

### SentimentDataRepository (Production Ready)

```java
public interface SentimentDataRepository extends JpaRepository<SentimentData, Long> {
    
    // Basic sentiment queries
    List<SentimentData> findBySocialPostId(Long socialPostId);
    
    // Platform-based sentiment analysis
    @Query("SELECT sp.platform, AVG(sd.sentimentScore), COUNT(sd) " +
           "FROM SentimentData sd JOIN sd.socialPost sp " +
           "WHERE sd.processedAt >= :since " +
           "GROUP BY sp.platform")
    List<Object[]> getPlatformSentimentStats(@Param("since") LocalDateTime since);
    
    // Confidence filtering
    List<SentimentData> findByConfidenceGreaterThan(Double minConfidence);
    
    // Sentiment label distribution
    @Query("SELECT sd.sentimentLabel, COUNT(sd) " +
           "FROM SentimentData sd " +
           "GROUP BY sd.sentimentLabel " +
           "ORDER BY COUNT(sd) DESC")
    List<Object[]> getSentimentDistribution();
}
```

## Engagement Score Algorithms

### Current Implementation (PostgreSQL Compatible)

**Reddit Engagement Formula**:
```java
private double calculateRedditEngagement() {
    long upvotes = this.upvotes != null ? this.upvotes : 0;
    long comments = this.commentCount != null ? this.commentCount : 0;
    
    // Comments weighted higher than upvotes (encourages discussion)
    double score = upvotes + (comments * 2.5);
    
    // Logarithmic scaling prevents extremely high outliers
    if (score > 1000) {
        score = 1000 + Math.log10(score - 999) * 100;
    }
    
    return Math.max(0, score);
}
```

**YouTube Engagement Formula**:
```java
private double calculateYouTubeEngagement() {
    long likes = this.likeCount != null ? this.likeCount : 0;
    long comments = this.commentCount != null ? this.commentCount : 0;
    long views = this.viewCount != null ? this.viewCount : 0;
    
    if (views == 0) {
        // No views data, use absolute engagement
        return (likes * 1.5) + (comments * 3.0);
    }
    
    // Calculate engagement rate based on views
    double engagementRate = ((double) (likes + comments)) / views;
    double baseEngagement = (likes * 1.5) + (comments * 3.0);
    
    // Combine rate and absolute engagement
    return (engagementRate * views * 0.1) + baseEngagement;
}
```

## Data Conversion Layer

### Reddit to SocialPost Mapping
```java
// From RedditIngestionService.convertToSocialPost()
SocialPost socialPost = new SocialPost(
    Platform.REDDIT,
    redditPost.getId(),        // external_id
    redditPost.getTitle(),     // title  
    redditPost.getContent(),   // content (selftext)
    redditPost.getAuthor()     // author
);

// Reddit-specific fields
socialPost.setUpvotes(redditPost.getScore());
socialPost.setCommentCount(redditPost.getNumComments());
socialPost.setSubreddit(redditPost.getSubreddit());
socialPost.setUrl(redditPost.getUrl());

// Auto-calculate engagement score
socialPost.calculateEngagementScore();
```

### YouTube to SocialPost Mapping  
```java
// From YouTubeIngestionService.convertToSocialPost()
SocialPost socialPost = new SocialPost(
    Platform.YOUTUBE,
    youtubeVideo.getId(),           // external_id
    youtubeVideo.getTitle(),        // title
    youtubeVideo.getDescription(),  // content
    youtubeVideo.getChannelTitle()  // author
);

// YouTube-specific fields
socialPost.setVideoId(youtubeVideo.getId());
socialPost.setLikeCount(youtubeVideo.getLikeCount());
socialPost.setViewCount(youtubeVideo.getViewCount());
socialPost.setCommentCount(youtubeVideo.getCommentCount());
socialPost.setUrl("https://www.youtube.com/watch?v=" + youtubeVideo.getId());

// Auto-calculate engagement score
socialPost.calculateEngagementScore();
```

## Production Database Setup

### Docker Configuration (Current)
```yaml
services:
  postgres:
    image: postgres:15
    container_name: socialsentiment-postgres
    environment:
      POSTGRES_DB: socialsentiment
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password123
    ports:
      - "5433:5432"  # Port 5433 to avoid conflicts
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d socialsentiment"]
      interval: 30s
      timeout: 10s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: socialsentiment-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

### Spring Boot Configuration
```properties
# PostgreSQL Configuration (Production)
spring.datasource.url=jdbc:postgresql://localhost:5433/socialsentiment
spring.datasource.username=postgres
spring.datasource.password=password123
spring.datasource.driver-class-name=org.postgresql.Driver

# JPA/Hibernate Configuration
spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true

# Redis Configuration
spring.data.redis.host=localhost
spring.data.redis.port=6379
spring.data.redis.timeout=2000ms
```

### AWS Production Migration (Ready)
```properties
# Replace local properties with:
spring.datasource.url=jdbc:postgresql://your-rds-endpoint:5432/socialsentiment
spring.datasource.username=${DB_USERNAME}
spring.datasource.password=${DB_PASSWORD}
spring.jpa.hibernate.ddl-auto=validate

# Redis (ElastiCache)
spring.data.redis.host=your-elasticache-endpoint
spring.data.redis.port=6379
```

## Data Validation Rules

### SocialPostDto Validation (PostgreSQL Compatible)
```java
@NotBlank(message = "External ID is required")
@Size(max = 100)
private String externalId;

@NotNull(message = "Platform is required")  
private Platform platform;

@NotBlank(message = "Title is required")
@Size(max = 500)
private String title;

@Size(max = 10000)
private String content;

@NotBlank(message = "Author is required")
@Size(max = 100)
private String author;

// Platform-specific validation
public boolean isValidForPlatform() {
    switch (platform) {
        case REDDIT:
            return content != null && !content.trim().isEmpty() && 
                   subreddit != null && !subreddit.trim().isEmpty();
        case YOUTUBE:
            return videoId != null && !videoId.trim().isEmpty();
        default:
            return false;
    }
}
```

## Database Management

### Common Operations
```sql
-- Check database size
SELECT pg_size_pretty(pg_database_size('socialsentiment'));

-- Check table sizes
SELECT schemaname, tablename, 
       pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- Check index usage
SELECT indexname, idx_scan, idx_tup_read, idx_tup_fetch 
FROM pg_stat_user_indexes 
WHERE schemaname = 'public';

-- Recent posts by platform
SELECT platform, COUNT(*), MAX(created_at) as latest
FROM social_posts 
WHERE created_at >= NOW() - INTERVAL '24 hours'
GROUP BY platform;
```

### Performance Monitoring
```sql
-- Top engaged posts by platform
SELECT platform, title, engagement_score, author
FROM social_posts 
ORDER BY engagement_score DESC 
LIMIT 20;

-- Sentiment distribution (when implemented)
SELECT sl.sentiment_label, COUNT(*) as count,
       AVG(sd.sentiment_score) as avg_score,
       AVG(sd.confidence) as avg_confidence
FROM sentiment_data sd
JOIN social_posts sp ON sd.social_post_id = sp.id
GROUP BY sd.sentiment_label
ORDER BY count DESC;

-- Platform comparison
SELECT 
    platform,
    COUNT(*) as total_posts,
    AVG(engagement_score) as avg_engagement,
    MAX(engagement_score) as max_engagement,
    AVG(comment_count) as avg_comments
FROM social_posts
GROUP BY platform;
```

## Extension Points

### Ready for Implementation
Your PostgreSQL setup is structured for these enhancements:

1. **Sentiment Analysis** - `SentimentData` table created with proper constraints
2. **Advanced Search** - PostgreSQL full-text search ready
3. **Analytics Reports** - Proper indexing for complex queries
4. **Redis Caching** - Connection configured, ready for implementation
5. **AWS Migration** - Schema compatible with RDS PostgreSQL

### Performance Optimizations Available
- **Full-text search** using PostgreSQL's built-in capabilities
- **Partitioning** by platform or date for large datasets
- **Connection pooling** with HikariCP (already configured)
- **Read replicas** for analytics queries
- **Materialized views** for complex aggregations

### Current Limitations
- **No sentiment processing service** - Tables exist but no NLP integration
- **No Redis caching implementation** - Configuration complete but not utilized
- **No advanced search endpoints** - Database ready but no API endpoints
- **No analytics generation** - Schema supports it but no service implementation

## Database Backup Strategy

### Development Backup
```bash
# Backup
docker exec socialsentiment-postgres pg_dump -U postgres socialsentiment > backup.sql

# Restore
docker exec -i socialsentiment-postgres psql -U postgres socialsentiment < backup.sql
```

### Production Considerations
- **Automated backups** with AWS RDS
- **Point-in-time recovery** for data protection
- **Read replicas** for read scaling
- **Connection pooling** for high concurrency
- **Monitoring** with CloudWatch metrics

This PostgreSQL-based data model successfully handles both Reddit and YouTube data with production-ready performance, proper constraints, and extensible design ready for cloud deployment and advanced features.